–©–æ–± –¥–æ–¥–∞—Ç–∏ –¥–æ Crypto‚ÄØDuel –ø–æ–≤–Ω–æ—Ü—ñ–Ω–Ω—É —Å–∏—Å—Ç–µ–º—É —Å–ø–æ–≤—ñ—â–µ–Ω—å –¥–ª—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤, —è–∫—ñ –ø—ñ–¥‚Äô—î–¥–Ω—É—é—Ç—å Farcaster‚Äë–≥–∞–º–∞–Ω–µ—Ü—å (–∞–ª–µ –Ω–µ –¥–ª—è —Ç–∏—Ö, —Ö—Ç–æ –≥—Ä–∞—î —á–µ—Ä–µ–∑ MetaMask), —Ç—Ä–µ–±–∞ —Ä–æ–∑—à–∏—Ä–∏—Ç–∏ —ñ—Å–Ω—É—é—á–∏–π –ø—Ä–æ–µ–∫—Ç —Ç—Ä—å–æ–º–∞ –Ω–∞–ø—Ä—è–º–∫–∞–º–∏:

–ü—Ä–∏–π–º–∞—Ç–∏ –π –∑–±–µ—Ä—ñ–≥–∞—Ç–∏ notification‚Äëtokens, —è–∫—ñ Warpcast/Farcaster –∫–ª—ñ—î–Ω—Ç –Ω–∞–¥—ñ—à–ª–µ –ø—Ä–∏ –∞–∫—Ç–∏–≤–∞—Ü—ñ—ó —Å–ø–æ–≤—ñ—â–µ–Ω—å.

–í—ñ–¥—Å–ª—ñ–¥–∫–æ–≤—É–≤–∞—Ç–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è –¥—É–µ–ª–µ–π –Ω–∞ –±–ª–æ–∫—á–µ–π–Ω—ñ –π –Ω–∞–¥—Å–∏–ª–∞—Ç–∏ –ø–µ—Ä—Å–æ–Ω–∞–ª—ñ–∑–æ–≤–∞–Ω—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è.

–ó–∞–ø—É—Å–∫–∞—Ç–∏ —â–æ–¥–µ–Ω–Ω—ñ –Ω–∞–≥–∞–¥—É–≤–∞–Ω–Ω—è –≤—Å—ñ–º –ø—ñ–¥–ø–∏—Å–∞–Ω–∏–º –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞–º.

–ù–∏–∂—á–µ –≤–∏–∫–ª–∞–¥–µ–Ω–æ –ø–æ–∫—Ä–æ–∫–æ–≤–∏–π –ø–ª–∞–Ω, —â–æ –±–∞–∑—É—î—Ç—å—Å—è –Ω–∞ –æ—Ñ—ñ—Ü—ñ–π–Ω—ñ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—ó Farcaster mini‚Äëapps —ñ –∫–æ–¥—ñ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—é.

1. –î–æ—Å–ª—ñ–¥–∏—Ç–∏ Farcaster API

–£ Farcaster —î –¥–≤–∞ —Ä—ñ–∑–Ω—ñ –º–µ—Ö–∞–Ω—ñ–∑–º–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å:

Mini‚Äëapp notifications ‚Äì –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –¥–æ–¥–∞—î –≤–∞—à –º—ñ–Ω—ñ‚Äë–¥–æ–¥–∞—Ç–æ–∫ —É Warpcast, –∞–∫—Ç–∏–≤—É—î ‚ÄúAllow notifications‚Äù, —ñ –∫–ª—ñ—î–Ω—Ç –≥–µ–Ω–µ—Ä—É—î token —Ç–∞ url. –ö–æ–ª–∏ —Ö–æ—á–µ—Ç–µ –Ω–∞–¥—ñ—Å–ª–∞—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è, —Ä–æ–±–∏—Ç–µ POST‚Äë–∑–∞–ø–∏—Ç –Ω–∞ —Ü–µ–π url –∑ –æ–±‚Äô—î–∫—Ç–æ–º { notificationId, title, body, targetUrl, tokens }. –¶–µ–π –º–µ—Ö–∞–Ω—ñ–∑–º –æ–ø–∏—Å–∞–Ω–∏–π —É —Ä–æ–∑–¥—ñ–ª—ñ ‚ÄúSending notifications‚Äù Farcaster mini‚Äëapps –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—ó
miniapps.farcaster.xyz
. –í–∞–∂–ª–∏–≤–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ —Å—Ç–∞–±—ñ–ª—å–Ω—ñ notificationId (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, duel-result-<id> —á–∏ daily-reminder-YYYY-MM-DD), —â–æ–± —É–Ω–∏–∫–∞—Ç–∏ –¥—É–±–ª—é–≤–∞–Ω—å
miniapps.farcaster.xyz
, —ñ –Ω–µ –ø–µ—Ä–µ–≤–∏—â—É–≤–∞—Ç–∏ –ª—ñ–º—ñ—Ç–∏ (1 –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∫–æ–∂–Ω—ñ 30¬†—Å —ñ 100 –Ω–∞ –¥–æ–±—É)
miniapps.farcaster.xyz
.

Warpcast Direct Cast API ‚Äì –¥–∞—î –∑–º–æ–≥—É –Ω–∞–¥—Å–∏–ª–∞—Ç–∏ –ø—Ä–∏–≤–∞—Ç–Ω—ñ ‚Äúdirect casts‚Äù –±—É–¥—å‚Äë—è–∫–∏–º –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞–º, –∞–ª–µ –ø–æ—Ç—Ä–µ–±—É—î –æ–∫—Ä–µ–º–æ–≥–æ API‚Äë–∫–ª—é—á–∞ (wc_secret_‚Ä¶). –û—Å–∫—ñ–ª—å–∫–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—é –≤–∞–∂–∫–æ –æ—Ç—Ä–∏–º–∞—Ç–∏, —É –ø–ª–∞–Ω—ñ –Ω–∏–∂—á–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –æ—Ñ—ñ—Ü—ñ–π–Ω–∏–π –º–µ—Ö–∞–Ω—ñ–∑–º mini‚Äëapp notifications. –ö–ª—é—á wc_secret_‚Ä¶ –º–æ–∂–Ω–∞ –∑–±–µ—Ä–µ–≥—Ç–∏ —è–∫ —Ä–µ–∑–µ—Ä–≤–Ω–∏–π —ñ —ñ–Ω—Ç–µ–≥—Ä—É–≤–∞—Ç–∏, —è–∫—â–æ Farcaster –ø—É–±–ª—ñ—á–Ω–æ –Ω–∞–¥–∞—Å—Ç—å Direct Cast API.

2. –ê—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∞ —Å–∏—Å—Ç–µ–º–∏

–ö–æ–º–ø–æ–Ω–µ–Ω—Ç–∏:

–ë–∞–∑–∞ –¥–∞–Ω–∏—Ö (PostgreSQL –∞–±–æ SQLite) –¥–ª—è –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è –≥–∞–º–∞–Ω—Ü—ñ–≤, FID —ñ notification‚Äëtoken‚Äô—ñ–≤:

CREATE TABLE farcaster_users (
  id SERIAL PRIMARY KEY,
  wallet_address VARCHAR(42) UNIQUE,
  fid INTEGER,
  username TEXT,
  notification_url TEXT,
  notification_token TEXT,
  notifications_enabled BOOLEAN DEFAULT TRUE,
  last_notification_sent TIMESTAMP,
  created_at TIMESTAMP DEFAULT NOW()
);


Webhook endpoint ‚Äì URL, —è–∫–∏–π Warpcast –±—É–¥–µ –≤–∏–∫–ª–∏–∫–∞—Ç–∏ –ø—Ä–∏ miniapp_added, notifications_enabled, notifications_disabled —ñ miniapp_removed
miniapps.farcaster.xyz
.

Duel listener ‚Äì WebSocket listener –∞–±–æ cron‚Äë–ø—Ä–æ—Ü–µ—Å, —è–∫–∏–π —Å–ª—É—Ö–∞—î –ø–æ–¥—ñ—é DuelCompleted —É —Å–º–∞—Ä—Ç‚Äë–∫–æ–Ω—Ç—Ä–∞–∫—Ç—ñ —ñ –≤—ñ–¥–ø—Ä–∞–≤–ª—è—î —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è –ø—Ä–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç.

Cron job ‚Äì —â–æ–¥–Ω—è –≤—ñ–¥–ø—Ä–∞–≤–ª—è—î –≤—Å—ñ–º –ø—ñ–¥–ø–∏—Å–∞–Ω–∏–º –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞–º –Ω–∞–≥–∞–¥—É–≤–∞–Ω–Ω—è –∑—ñ —Å–ª–æ–≤–∞–º–∏ ‚ÄúReady for another crypto duel?‚Äù.

API‚Äë–µ–Ω–¥–ø–æ—ñ–Ω—Ç–∏ –¥–ª—è –ø—ñ–¥–ø–∏—Å–∫–∏/–≤—ñ–¥–ø–∏—Å–∫–∏ —Ç–∞ —Ç–µ—Å—Ç–æ–≤–∏—Ö –≤–∏–∫–ª–∏–∫—ñ–≤.

–¢–µ—Ö–Ω—ñ—á–Ω–∏–π —Å—Ç–µ–∫: Next.js API routes, ethers.js –¥–ª—è –ø—Ä–æ—Å–ª—É—Ö–æ–≤—É–≤–∞–Ω–Ω—è —Å–º–∞—Ä—Ç‚Äë–∫–æ–Ω—Ç—Ä–∞–∫—Ç—É, node-cron –∞–±–æ Vercel Cron –¥–ª—è –ø–ª–∞–Ω—É–≤–∞–ª—å–Ω–∏–∫–∞, —Ç–∞ –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∞ @farcaster/miniapp-node –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –ø—ñ–¥–ø–∏—Å—ñ–≤ –≤—ñ–¥ Warpcast.

3. –î–æ–¥–∞–≤–∞–Ω–Ω—è webhook —É manifest

–£ –≤–∞—à–æ–º—É farcaster.json (–≤ public/.well-known –∞–±–æ —á–µ—Ä–µ–∑ API‚Äëendpoint /api/manifest) –¥–æ–¥–∞–π—Ç–µ –ø–æ–ª–µ webhookUrl:

{
  "version": "1",
  "name": "Crypto Duel",
  "iconUrl": "https://cryptoduel.xyz/icon.png",
  "homeUrl": "https://cryptoduel.xyz/app",
  "imageUrl": "https://cryptoduel.xyz/image.png",
  "buttonTitle": "Play",
  "splashImageUrl": "https://cryptoduel.xyz/splash.png",
  "splashBackgroundColor": "#1d1231",
  "webhookUrl": "https://cryptoduel.xyz/api/farcaster-webhook"
}
}


–ü—ñ—Å–ª—è –¥–µ–ø–ª–æ—é –º—ñ–Ω—ñ‚Äë–∞–ø–∫–∏ –≤ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ –∑‚Äô—è–≤–∏—Ç—å—Å—è –º–æ–∂–ª–∏–≤—ñ—Å—Ç—å —É–≤—ñ–º–∫–Ω—É—Ç–∏ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è; Warpcast –±—É–¥–µ —Å–ª–∞—Ç–∏ –ø–æ–¥—ñ—ó –Ω–∞ /api/farcaster-webhook
miniapps.farcaster.xyz
.

4. Webhook endpoint –¥–ª—è –æ–±—Ä–æ–±–∫–∏ –ø–æ–¥—ñ–π

–°—Ç–≤–æ—Ä—ñ—Ç—å —Ñ–∞–π–ª pages/api/farcaster-webhook.js:

// pages/api/farcaster-webhook.js
import { parseWebhookEvent, verifyAppKeyWithNeynar } from '@farcaster/miniapp-node';
import db from '@/lib/database'; // –≤–∞—à –º–æ–¥—É–ª—å –ë–î

export const config = { api: { bodyParser: true } };

export default async function handler(req, res) {
  // –ø—Ä–∏–π–º–∞—î–º–æ –ª–∏—à–µ POST
  if (req.method !== 'POST') return res.status(405).send('Method not allowed');

  // –í–∞–ª—ñ–¥–∞—Ü—ñ—è –ø—ñ–¥–ø–∏—Å—É. Neynar API –ø–æ—Ç—Ä–µ–±—É—î `FARCASTER_APP_KEY` —Ç–∞ `FARCASTER_APP_SECRET`
  try {
    const event = parseWebhookEvent(req.body);
    // verify signature if necessary:
    await verifyAppKeyWithNeynar(event, {
      appFid: process.env.FARCASTER_APP_FID,
      neynarApiKey: process.env.NEYNAR_API_KEY
    });

    const { event: eventType, fid, userFid, notificationDetails } = event;

    const savedFid = fid ?? userFid;
    if (!savedFid) return res.status(200).json({ ok: true });

    if (eventType === 'miniapp_added' || eventType === 'notifications_enabled') {
      // –∑–±–µ—Ä—ñ–≥–∞—î–º–æ notification url + token
      await db.upsertUser({
        fid: savedFid,
        notification_url: notificationDetails.url,
        notification_token: notificationDetails.token,
        notifications_enabled: true
      });
    } else if (eventType === 'notifications_disabled' || eventType === 'miniapp_removed') {
      await db.updateUser(savedFid, { notifications_enabled: false });
    }

    return res.status(200).json({ ok: true });
  } catch (err) {
    console.error('Webhook error:', err);
    return res.status(400).json({ error: err.message });
  }
}


–¶–µ–π endpoint –ø—Ä–∏–π–º–∞—î –ø–æ–¥—ñ—ó Farcaster, –ø–µ—Ä–µ–≤—ñ—Ä—è—î –ø—ñ–¥–ø–∏—Å —ñ –∑–±–µ—Ä—ñ–≥–∞—î (–∞–±–æ –≤–∏–¥–∞–ª—è—î) tokens —É –ë–î.

5. –û—Ç—Ä–∏–º–∞–Ω–Ω—è FID —ñ –ø—ñ–¥–ø–∏—Å–∫–∞ –∑—ñ —Å—Ç–æ—Ä–æ–Ω–∏ –∫–ª—ñ—î–Ω—Ç–∞

–£ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ñ FarcasterInit.js (–≤—ñ–Ω —É–∂–µ –∑–∞–≤–∞–Ω—Ç–∞–∂—É—î context —ñ –ø–æ–∫–∞–∑—É—î FID) —Å–ª—ñ–¥ –≤–∏–∫–ª–∏–∫–∞—Ç–∏ –≤–∞—à API, —â–æ–± –∑–±–µ—Ä–µ–≥—Ç–∏ FID —ñ –∞–¥—Ä–µ—Å—É –≥–∞–º–∞–Ω—Ü—è. –ù–∞–ø—Ä–∏–∫–ª–∞–¥, –ø—ñ—Å–ª—è —É—Å–ø—ñ—à–Ω–æ–≥–æ sdk.actions.ready() —ñ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è context:

import { sdk } from '@farcaster/miniapp-sdk';

async function subscribeUserToNotifications(address) {
  const context = typeof sdk.context === 'function' ? sdk.context() : sdk.context;
  if (!context?.user?.fid) return;

  await fetch('/api/notifications/subscribe', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      fid: context.user.fid,
      username: context.user.username,
      walletAddress: address
    })
  });
}


–§–∞–π–ª pages/api/notifications/subscribe.js:

// pages/api/notifications/subscribe.js
import db from '@/lib/database';

export default async function handler(req, res) {
  if (req.method !== 'POST') return res.status(405).end('Method not allowed');

  const { fid, username, walletAddress } = req.body;
  if (!fid || !walletAddress) return res.status(400).json({ error: 'Missing fid or wallet' });

  await db.upsertUser({
    fid: Number(fid),
    username,
    wallet_address: walletAddress.toLowerCase()
  });
  res.status(200).json({ ok: true });
}


–¶–µ –¥–æ–∑–≤–æ–ª–∏—Ç—å –∑–≤‚Äô—è–∑–∞—Ç–∏ on‚Äëchain –∞–¥—Ä–µ—Å—É –∑ FID –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –≤ —Ç–∞–±–ª–∏—Ü—ñ farcaster_users.

6. –°–ª—É—Ö–∞—á –ø–æ–¥—ñ–π –¥—É–µ–ª–µ–π

–°—Ç–≤–æ—Ä—ñ—Ç—å –º–æ–¥—É–ª—å lib/blockchain.js, —è–∫–∏–π –ø—ñ–¥–∫–ª—é—á–∞—î—Ç—å—Å—è –¥–æ —Å–º–∞—Ä—Ç‚Äë–∫–æ–Ω—Ç—Ä–∞–∫—Ç—É —á–µ—Ä–µ–∑ ethers —ñ —Å–ª—É—Ö–∞—î –ø–æ–¥—ñ—é DuelCompleted(duelId, winner, prize, randomSeed)
raw.githubusercontent.com
:

// lib/blockchain.js
import { ethers } from 'ethers';
import { sendResultNotification } from './notifications';
import db from './database';

const provider = new ethers.WebSocketProvider(process.env.BASE_RPC_WSS);
const contract = new ethers.Contract(process.env.CONTRACT_ADDRESS, CONTRACT_ABI, provider);

export function listenForDuels() {
  contract.on('DuelCompleted', async (duelId, winner, prize, randomSeed) => {
    const duelIdNum = Number(duelId);
    const winnerAddr = winner.toLowerCase();
    const prizeEth = ethers.formatEther(prize);
    // –ó–Ω–∞—Ö–æ–¥–∏–º–æ –æ–±–æ—Ö –≥—Ä–∞–≤—Ü—ñ–≤ —á–µ—Ä–µ–∑ —Å–≤–æ—é –±—ñ–∑–Ω–µ—Å‚Äë–ª–æ–≥—ñ–∫—É (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, —á–∏—Ç–∞—î–º–æ getDuel())
    const duel = await contract.getDuel(duelIdNum);
    const players = [duel.player1.toLowerCase(), duel.player2.toLowerCase()];

    // –î–ª—è –∫–æ–∂–Ω–æ–≥–æ –≥—Ä–∞–≤—Ü—è —à—É–∫–∞—î–º–æ –π–æ–≥–æ FID —É –ë–î —ñ –≤—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è
    for (const addr of players) {
      const user = await db.getUserByWallet(addr);
      if (!user || !user.notifications_enabled || !user.notification_url) continue;
      const won = addr === winnerAddr;
      await sendResultNotification(user, {
        duelId: duelIdNum,
        win: won,
        prizeEth
      });
    }
  });
}


–§—É–Ω–∫—Ü—ñ—è sendResultNotification() —Å—Ç–≤–æ—Ä—é—î —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è —ñ —Ä–æ–±–∏—Ç—å POST –Ω–∞ notification_url:

// lib/notifications.js
import fetch from 'node-fetch';

export async function sendResultNotification(user, { duelId, win, prizeEth }) {
  const notificationId = `duel-${duelId}-${user.fid}`; // —Å—Ç–∞–±—ñ–ª—å–Ω–∏–π id
  const title = win ? 'ü•≥ You won your duel!' : 'üòì Duel result';
  const body = win
    ? `You won ${prizeEth} ETH in duel #${duelId}!`
    : `You lost your duel #${duelId}. Better luck next time!`;
  const payload = {
    notificationId,
    title,
    body,
    targetUrl: `https://cryptoduel.xyz/duel/${duelId}`,
    tokens: [user.notification_token]
  };
  await fetch(user.notification_url, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  });
}


–¢–∞–∫–∏–º —á–∏–Ω–æ–º, –∫–æ–ª–∏ –∫–æ–Ω—Ç—Ä–∞–∫—Ç –≥–µ–Ω–µ—Ä—É—î DuelCompleted, –∫–æ–∂–µ–Ω –∑–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω–∏–π –≥—Ä–∞–≤–µ—Ü—å –æ—Ç—Ä–∏–º–∞—î push‚Äë–ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º.

7. –©–æ–¥–µ–Ω–Ω—ñ –Ω–∞–≥–∞–¥—É–≤–∞–Ω–Ω—è —á–µ—Ä–µ–∑ Cron

–°—Ç–≤–æ—Ä—ñ—Ç—å lib/dailyReminder.js –¥–ª—è —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—É —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∑–∞ –¥–æ–±—É:

import { ethers } from 'ethers';
import db from './database';

export async function getActiveFarcasterUsers() {
  return db.getUsersWithNotificationsEnabled();
}

export async function sendDailyReminders() {
  const users = await getActiveFarcasterUsers();
  for (const user of users) {
    // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞, —â–æ–± –Ω–µ —Å–ø–∞–º–∏—Ç–∏ —è–∫—â–æ –≤–∂–µ –Ω–∞–¥—Å–∏–ª–∞–ª–∏ —Ü—å–æ–≥–æ –¥–Ω—è
    if (user.last_notification_sent && new Date() - user.last_notification_sent < 12 * 60 * 60 * 1000) continue;
    const id = `daily-${new Date().toISOString().slice(0,10)}-${user.fid}`;
    const body = `Ready for another crypto duel? üéÆ Challenge someone today!`;
    const payload = {
      notificationId: id,
      title: 'Time to Duel!',
      body,
      targetUrl: 'https://cryptoduel.xyz/app',
      tokens: [user.notification_token]
    };
    await fetch(user.notification_url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    await db.updateUser(user.fid, { last_notification_sent: new Date() });
  }
}


–£ —Ñ–∞–π–ª—ñ pages/api/cron/daily.js –º–æ–∂–Ω–∞ –∑–∞–ø—É—Å—Ç–∏—Ç–∏ –Ω–∞–≥–∞–¥—É–≤–∞–Ω–Ω—è:

// pages/api/cron/daily.js
import { sendDailyReminders } from '@/lib/dailyReminder';

export default async function handler(req, res) {
  if (req.method !== 'POST') return res.status(405).end();
  await sendDailyReminders();
  res.status(200).json({ ok: true });
}


–î–ª—è –ø–ª–∞–Ω—É–≤–∞–Ω–Ω—è –≤–∏–∫–ª–∏–∫—É –Ω–∞ Vercel –º–æ–∂–Ω–∞ –¥–æ–¥–∞—Ç–∏ –¥–æ vercel.json:

{
  "triggers": [
    {
      "type": "cron",
      "schedule": "0 12 * * *",
      "url": "/api/cron/daily"
    }
  ]
}


–ù–∞ –∑–≤–∏—á–∞–π–Ω–æ–º—É —Å–µ—Ä–≤–µ—Ä—ñ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ node-cron:

import cron from 'node-cron';
import { sendDailyReminders } from './lib/dailyReminder';

cron.schedule('0 12 * * *', sendDailyReminders); // 12:00 UTC —â–æ–¥–Ω—è

8. –Ü–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—è –∑ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–æ–º

–î–æ–¥–∞–π—Ç–µ –∫–Ω–æ–ø–∫—É ‚ÄúEnable notifications‚Äù —É –≤–∞—à—ñ–π –≥—Ä—ñ, —è–∫–∞ –≤–∏–∫–ª–∏–∫–∞—î sdk.actions.addMiniApp() ‚Äì –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–µ–≤—ñ –∑‚Äô—è–≤–∏—Ç—å—Å—è –¥—ñ–∞–ª–æ–≥ —É–≤—ñ–º–∫–Ω–µ–Ω–Ω—è —Å–ø–æ–≤—ñ—â–µ–Ω—å.

–ü—ñ—Å–ª—è –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è Farcaster‚Äë–≥–∞–º–∞–Ω—Ü—è –π —É—Å–ø—ñ—à–Ω–æ–≥–æ ready(), –≤–∏–∫–ª–∏–∫–∞–π—Ç–µ subscribeUserToNotifications(address) ‚Äì —Ü–µ –∑–±–µ—Ä–µ–∂–µ FID —Ç–∞ –∞–¥—Ä–µ—Å—É —É –ë–î.

–£ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ñ ‚ÄúMy Duels‚Äù –¥–æ–¥–∞–π—Ç–µ —ñ–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø—ñ–¥–ø–∏—Å–∫–∏ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, –ø—Ä–∞–ø–æ—Ä–µ—Ü—å ‚ÄúNotifications enabled‚Äù) —Ç–∞ –∫–Ω–æ–ø–∫—É –¥–ª—è –≤—ñ–¥–ø–∏—Å–∫–∏, —â–æ —à–ª–µ –∑–∞–ø–∏—Ç –Ω–∞ /api/notifications/unsubscribe.

9. –ü—ñ–¥—Å—É–º–æ–∫

–ó–±–µ—Ä—ñ–≥–∞—î–º–æ FIDs, —Ç–æ–∫–µ–Ω–∏ —Ç–∞ URL –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å —É –ë–î (–æ–¥–∏–Ω —Ä—è–¥–æ–∫ –Ω–∞ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞).

–û–±—Ä–æ–±–ª—è—î–º–æ –ø–æ–¥—ñ—ó miniapp_added / notifications_enabled —â–æ–± –æ—Ç—Ä–∏–º–∞—Ç–∏ notificationDetails —ñ –∑–±–µ—Ä–µ–≥—Ç–∏ token —Ç–∞ url
miniapps.farcaster.xyz
.

–í–∏–∫–ª–∏–∫–∞—î–º–æ contract.on('DuelCompleted', ...), –∑–Ω–∞—Ö–æ–¥–∏–º–æ FID –æ–±–æ—Ö –≥—Ä–∞–≤—Ü—ñ–≤ —Ç–∞ –Ω–∞–¥—Å–∏–ª–∞—î–º–æ –ø–µ—Ä—Å–æ–Ω–∞–ª—ñ–∑–æ–≤–∞–Ω—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è.

–ù–∞–ª–∞—à—Ç–æ–≤—É—î–º–æ —â–æ–¥–µ–Ω–Ω–∏–π cron job, —â–æ–± –Ω–∞–¥—Å–∏–ª–∞—Ç–∏ –Ω–∞–≥–∞–¥—É–≤–∞–Ω–Ω—è.

–í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ —Å—Ç–∞–±—ñ–ª—å–Ω—ñ notificationId –π –¥–æ—Ç—Ä–∏–º—É—î–º–æ—Å—å –ª—ñ–º—ñ—Ç—ñ–≤ Farcaster (–Ω–µ –±—ñ–ª—å—à–µ 1 –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∫–æ–∂–Ω—ñ 30¬†—Å —ñ 100 –Ω–∞ –¥–æ–±—É)
miniapps.farcaster.xyz
.

–Ø–∫—â–æ –∑–≥–æ–¥–æ–º –∑–∞—Ö–æ—á–µ—Ç–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ Direct Cast API (wc_secret_...), –∑–∞–º—ñ–Ω—ñ—Ç—å sendResultNotification() —Ç–∞ sendDailyReminders() –Ω–∞ –≤–∏–∫–ª–∏–∫–∏ –æ—Ñ—ñ—Ü—ñ–π–Ω–æ–≥–æ Warpcast API –∑ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ–π–Ω–∏–º –∑–∞–≥–æ–ª–æ–≤–∫–æ–º Bearer ${process.env.WC_SECRET}; —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ JSON (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥ recipientFid, text —ñ embeds) –æ–ø–∏—Å–∞–Ω–∞ —É Warpcast API –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—ó.

–¶–µ–π –ø—ñ–¥—Ö—ñ–¥ –Ω–∞–¥–∞—î –Ω–∞–¥—ñ–π–Ω—É —Å–∏—Å—Ç–µ–º—É —Å–ø–æ–≤—ñ—â–µ–Ω—å –¥–ª—è –≥—Ä–∞–≤—Ü—ñ–≤ –∑ Farcaster‚Äë–≥–∞–º–∞–Ω—Ü—è–º–∏: –≤–æ–Ω–∏ –æ—Ç—Ä–∏–º—É—é—Ç—å push‚Äë–ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—ñ—Å–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è –¥—É–µ–ª—ñ —Ç–∞ —â–æ–¥–µ–Ω–Ω—ñ –∑–∞–ø—Ä–æ—à–µ–Ω–Ω—è –∑–º–∞–≥–∞—Ç–∏—Å—è, –∞ —Ç–∞–∫–æ–∂ –º–æ–∂—É—Ç—å –ª–µ–≥–∫–æ –≤–º–∏–∫–∞—Ç–∏/–≤–∏–º–∏–∫–∞—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è.